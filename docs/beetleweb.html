<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Beetle sur le web</title>
        <!--<link rel="stylesheet" href="main.css">-->
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="div_logo">
            <img src="images/logo.png" width="250"/>
        </div>
        <div class="div_title">
            <h1>VIII. Beetle sur le web</h1>
        </div>
        <div style="clear:both;"><hr></div>

        <p><a href="console.html">Précédent : VII. Console</a> | <a href="index.html">Index</a> | <a href="filesystem.html">Suivant : IX. Système de fichiers</a></p>

        <h3>1. Principe général</h3>
        <p>
            Beetle peut être utilisé de deux manières complémentaires :
        </p>
        <ul>
            <li>en <b>console interactive</b> ;</li>
            <li>en <b>mode web</b>, où la sortie standard de Beetle est redirigée vers une page HTML.</li>
        </ul>
        <p>
            En mode web, Apache joue uniquement le rôle de <b>routeur HTTP</b>. Le traitement logique est entièrement réalisé par Beetle
            via le script Python 'browser.py'.
        </p>

        <h3>2. Appel direct via browser.py</h3>
        <p>
            Le point d'entrée web de Beetle est le script suivant :
        </p>
        <div class="div_code"><code>
            http://localhost/pybee/browser.py?file=my_filename&path=my_path
        </code></div>

        <p>
            Le paramètre 'file' ne doit pas contenir l'extension '.btl'. Beetle chargera automatiquement le fichier
            'my_filename.btl'.
        </p>

        <h4>Gestion du paramètre 'path'</h4>
        <ul>
            <li><b>absent</b> : Beetle utilise le répertoire 'userarea' ;</li>
            <li><b>path=default</b> : équivalent au cas précédent ;</li>
            <li><b>path=autre</b> : Beetle charge les fichiers depuis le chemin fourni et met à jour sa variable interne 'path'.</li>
        </ul>

        <p>
            Ce mécanisme permet de séparer totalement les fichiers Beetle des fichiers visibles par le navigateur.
            Les scripts '.btl' ne sont jamais exposés directement.
        </p>

        <h3>3. Exemple simple</h3>
        <p>
            Si le fichier 'test.btl' est présent dans 'userarea', l'URL suivante exécutera le programme :
        </p>
        <div class="div_code"><code>
            http://localhost/pybee/browser.py?file=test
        </code></div>

        <p>
            En cas d'erreur de syntaxe ou d'exécution, les messages d'erreur Beetle sont affichés directement dans la page web.
        </p>

        <h3>4. URLs simplifiées avec mod_rewrite</h3>
        <p>
            Pour obtenir des URLs plus naturelles, il est possible d'utiliser la réécriture d'URL Apache afin d'appeler directement
            des fichiers '.btl'.
        </p>

        <h4>Fichier .htaccess</h4>
        <p>
            Placez le fichier '.htaccess' suivant dans le répertoire 'pybee' (normalement, il est déjà positionné) :
        </p>

        <div class="div_code"><code>
            RewriteEngine On<br>
            RewriteRule ^(.+)\.btl$ /pybee/browser.py?file=$1 [QSA,L]
        </code></div>

        <p>
            L'URL suivante devient alors valide :
        </p>
        <div class="div_code"><code>
            http://localhost/pybee/test.btl
        </code></div>

        <h3>5. Configuration Apache requise (Windows / WAMP)</h3>

        <p>
            Sous Windows, Apache n'exécute jamais automatiquement les scripts Python. Une configuration explicite est indispensable.
        </p>

        <h4>Modules requis</h4>
        <ul>
            <li>mod_rewrite</li>
            <li>mod_cgi</li>
        </ul>

        <h4>Configuration minimale</h4>
        <div class="div_code"><code>
            &lt;Directory "${INSTALL_DIR}/www"&gt;<br>
            &nbsp;&nbsp;Options +FollowSymLinks -Multiviews +ExecCGI<br>
            &nbsp;&nbsp;AllowOverride All<br>
            &nbsp;&nbsp;Require all granted<br>
            &nbsp;&nbsp;AddHandler cgi-script .py<br>
            &lt;/Directory&gt;
        </code></div>

        <p>
            <b>Important :</b> l'option '-Multiviews' est obligatoire. Elle évite qu'Apache intercepte les URLs avant
            l'application des règles de réécriture.
        </p>

        <h4>Script Python CGI</h4>
        <p>
            Le fichier 'browser.py' doit respecter les règles CGI suivantes :
        </p>
        <ul>
            <li>shebang absolu vers Python ;</li>
            <li>en-tête HTTP 'Content-Type' obligatoire ;</li>
            <li>aucune sortie avant les headers.</li>
        </ul>

        <div class="div_code"><code>
            #!C:/Users/USER/AppData/Local/Programs/Python/Python312/python.exe<br>
            print("Content-Type: text/html; charset=utf-8\r\n")
        </code></div>

        <h3>6. Problèmes courants</h3>
        <ul>
            <li><b>Le code Python s'affiche dans le navigateur</b> : AddHandler cgi-script .py manquant.</li>
            <li><b>La réécriture ne fonctionne pas</b> : Multiviews activé ou .htaccess mal placé.</li>
            <li><b>Erreur 500</b> : shebang incorrect, header manquant ou erreur Python.</li>
        </ul>

        <p>
            Les erreurs Apache sont consultables dans :<br>
            <code>c:/wamp64/logs/apache_error.log</code>
        </p>

        <h3>7. Remarque architecturale</h3>
        <p>
            <b>Beetle ne dépend pas d'Apache.</b> Apache peut être remplacé par tout autre serveur HTTP.
            Il est uniquement utilisé ici comme serveur de fichiers statiques et routeur web.
        </p>

        <p><a href="console.html">Précédent : VII. Console</a> | <a href="index.html">Index</a> | <a href="filesystem.html">Suivant : IX. Système de fichiers</a></p>
    </body>
</html>